<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acquisition System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f1117; color: #e1e4e8; }
        .header { background: #161b22; border-bottom: 1px solid #30363d; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header .status { font-size: 13px; color: #8b949e; }
        .header .status .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #3fb950; margin-right: 6px; }

        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .kpi-card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; }
        .kpi-card .label { font-size: 12px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .kpi-card .value { font-size: 28px; font-weight: 700; }
        .kpi-card .sub { font-size: 12px; color: #8b949e; margin-top: 4px; }
        .kpi-card.hot .value { color: #f85149; }
        .kpi-card.warm .value { color: #d29922; }
        .kpi-card.green .value { color: #3fb950; }

        /* Sections */
        .section { background: #161b22; border: 1px solid #30363d; border-radius: 8px; margin-bottom: 24px; }
        .section-header { padding: 16px 20px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; }
        .section-header h2 { font-size: 16px; font-weight: 600; }
        .section-body { padding: 20px; }

        /* Pipeline Funnel */
        .funnel { display: flex; gap: 8px; align-items: flex-end; height: 160px; padding: 0 20px; }
        .funnel-stage { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .funnel-bar { width: 100%; border-radius: 4px 4px 0 0; min-height: 8px; transition: height 0.5s; }
        .funnel-label { font-size: 11px; color: #8b949e; margin-top: 8px; text-align: center; }
        .funnel-count { font-size: 18px; font-weight: 700; margin-top: 4px; }

        /* Table */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-size: 12px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; padding: 10px 12px; border-bottom: 1px solid #30363d; }
        td { padding: 12px; border-bottom: 1px solid #21262d; font-size: 14px; }
        tr:hover td { background: #1c2128; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-hot { background: rgba(248,81,73,0.15); color: #f85149; }
        .badge-warm { background: rgba(210,153,34,0.15); color: #d29922; }
        .badge-cold { background: rgba(139,148,158,0.15); color: #8b949e; }
        .score-bar { width: 60px; height: 6px; background: #21262d; border-radius: 3px; display: inline-block; vertical-align: middle; margin-right: 8px; }
        .score-fill { height: 100%; border-radius: 3px; }

        /* Tabs */
        .tabs { display: flex; gap: 4px; margin-bottom: 16px; }
        .tab { padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; border: 1px solid transparent; background: none; color: #8b949e; }
        .tab.active { background: #21262d; color: #e1e4e8; border-color: #30363d; }
        .tab:hover { color: #e1e4e8; }

        /* Two column */
        .two-col { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
        @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }

        /* Charts (simple CSS) */
        .bar-chart { display: flex; gap: 4px; align-items: flex-end; height: 120px; }
        .bar { flex: 1; border-radius: 2px 2px 0 0; background: #388bfd; min-width: 20px; transition: height 0.3s; position: relative; }
        .bar:hover { background: #58a6ff; }
        .bar-label { position: absolute; bottom: -18px; left: 50%; transform: translateX(-50%); font-size: 10px; color: #8b949e; white-space: nowrap; }

        .loading { text-align: center; padding: 40px; color: #8b949e; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Acquisition System</h1>
        <div class="status"><span class="dot"></span>Connected</div>
    </div>

    <div class="container">
        <!-- KPI Cards -->
        <div class="kpi-grid" id="kpi-grid">
            <div class="kpi-card"><div class="label">Total Businesses</div><div class="value" id="kpi-total">--</div></div>
            <div class="kpi-card hot"><div class="label">Hot Leads</div><div class="value" id="kpi-hot">--</div></div>
            <div class="kpi-card warm"><div class="label">With Email</div><div class="value" id="kpi-email">--</div></div>
            <div class="kpi-card green"><div class="label">Emails Sent</div><div class="value" id="kpi-sent">--</div></div>
            <div class="kpi-card green"><div class="label">Replies</div><div class="value" id="kpi-replies">--</div><div class="sub" id="kpi-reply-rate"></div></div>
            <div class="kpi-card"><div class="label">Active Deals</div><div class="value" id="kpi-deals">--</div></div>
        </div>

        <div class="two-col">
            <!-- Hot Leads Table -->
            <div class="section">
                <div class="section-header">
                    <h2>Top Leads</h2>
                    <div class="tabs">
                        <button class="tab active" onclick="loadLeads('hot')">Hot</button>
                        <button class="tab" onclick="loadLeads('warm')">Warm</button>
                        <button class="tab" onclick="loadLeads(null)">All</button>
                    </div>
                </div>
                <div class="section-body" style="padding:0;">
                    <table>
                        <thead><tr>
                            <th>Business</th><th>Industry</th><th>Location</th><th>Score</th><th>Owner</th><th>Email</th>
                        </tr></thead>
                        <tbody id="leads-table"><tr><td colspan="6" class="loading">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Deal Pipeline -->
            <div class="section">
                <div class="section-header"><h2>Deal Pipeline</h2></div>
                <div class="section-body">
                    <div class="funnel" id="pipeline-funnel">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campaign Stats -->
        <div class="section">
            <div class="section-header"><h2>Campaign Performance</h2></div>
            <div class="section-body" style="padding:0;">
                <table>
                    <thead><tr>
                        <th>Campaign</th><th>Status</th><th>Sent</th><th>Delivered</th><th>Opened</th><th>Open Rate</th><th>Replied</th><th>Reply Rate</th>
                    </tr></thead>
                    <tbody id="campaigns-table"><tr><td colspan="8" class="loading">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- Score Distribution -->
        <div class="section">
            <div class="section-header"><h2>Score Distribution</h2></div>
            <div class="section-body">
                <div class="bar-chart" id="score-chart"><div class="loading">Loading...</div></div>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';

        async function fetchJSON(url) {
            try {
                const r = await fetch(API + url);
                return await r.json();
            } catch (e) {
                console.error('API error:', url, e);
                return null;
            }
        }

        function fmt(n) {
            if (n == null) return '--';
            return Number(n).toLocaleString();
        }

        // Load overview KPIs
        async function loadOverview() {
            const data = await fetchJSON('/businesses/overview');
            if (!data) return;

            document.getElementById('kpi-total').textContent = fmt(data.total_businesses);
            document.getElementById('kpi-hot').textContent = fmt(data.hot_leads);
            document.getElementById('kpi-email').textContent = fmt(data.with_email);
            document.getElementById('kpi-sent').textContent = fmt(data.emails_sent);
            document.getElementById('kpi-replies').textContent = fmt(data.replies);
            document.getElementById('kpi-deals').textContent = fmt(data.active_deals);

            if (data.emails_sent > 0) {
                const rate = ((data.replies / data.emails_sent) * 100).toFixed(1);
                document.getElementById('kpi-reply-rate').textContent = rate + '% reply rate';
            }
        }

        // Load leads table
        async function loadLeads(tier) {
            // Update tab styles
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event?.target?.classList?.add('active');

            const url = tier ? `/leads?tier=${tier}&limit=20` : '/leads?limit=20';
            const data = await fetchJSON(url);
            const tbody = document.getElementById('leads-table');

            if (!data || !data.leads.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">No leads found</td></tr>';
                return;
            }

            tbody.innerHTML = data.leads.map(l => {
                const score = parseFloat(l.composite_score || 0);
                const tier = l.score_tier || 'cold';
                const pct = Math.round(score * 100);
                const color = tier === 'hot' ? '#f85149' : tier === 'warm' ? '#d29922' : '#8b949e';

                return `<tr>
                    <td><strong>${esc(l.name || '')}</strong></td>
                    <td>${esc(l.industry || '--')}</td>
                    <td>${esc(l.city || '')}${l.state ? ', ' + l.state : ''}</td>
                    <td>
                        <span class="score-bar"><span class="score-fill" style="width:${pct}%;background:${color}"></span></span>
                        <span class="badge badge-${tier}">${score.toFixed(2)}</span>
                    </td>
                    <td>${esc(l.owner_name || '--')}</td>
                    <td>${l.email ? esc(l.email) : '<span style="color:#8b949e">--</span>'}</td>
                </tr>`;
            }).join('');
        }

        // Load pipeline funnel
        async function loadPipeline() {
            const data = await fetchJSON('/deals/pipeline');
            const el = document.getElementById('pipeline-funnel');

            if (!data || !data.pipeline.length) {
                el.innerHTML = '<div class="loading">No active deals</div>';
                return;
            }

            const max = Math.max(...data.pipeline.map(s => s.count), 1);
            const colors = ['#388bfd', '#388bfd', '#58a6ff', '#58a6ff', '#79c0ff', '#79c0ff', '#3fb950', '#f85149'];

            el.innerHTML = data.stages.map((stage, i) => {
                const item = data.pipeline.find(p => p.stage === stage) || { count: 0 };
                const h = Math.max(8, (item.count / max) * 140);
                const label = stage.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                return `<div class="funnel-stage">
                    <div class="funnel-count">${item.count}</div>
                    <div class="funnel-bar" style="height:${h}px;background:${colors[i] || '#388bfd'}"></div>
                    <div class="funnel-label">${label}</div>
                </div>`;
            }).join('');
        }

        // Load campaign stats
        async function loadCampaigns() {
            const data = await fetchJSON('/campaigns/stats');
            const tbody = document.getElementById('campaigns-table');

            if (!data || !data.campaigns.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">No campaigns</td></tr>';
                return;
            }

            tbody.innerHTML = data.campaigns.map(c => `<tr>
                <td><strong>${esc(c.name)}</strong></td>
                <td><span class="badge badge-${c.status === 'active' ? 'hot' : 'cold'}">${c.status}</span></td>
                <td>${fmt(c.total_sent)}</td>
                <td>${fmt(c.total_delivered)}</td>
                <td>${fmt(c.total_opened)}</td>
                <td>${c.open_rate || 0}%</td>
                <td>${fmt(c.total_replied)}</td>
                <td>${c.reply_rate || 0}%</td>
            </tr>`).join('');
        }

        // Load score distribution
        async function loadScoreDistribution() {
            const data = await fetchJSON('/leads/stats');
            const el = document.getElementById('score-chart');

            if (!data || !data.score_distribution?.length) {
                el.innerHTML = '<div class="loading">No scoring data</div>';
                return;
            }

            const max = Math.max(...data.score_distribution.map(b => b.count), 1);
            const labels = ['0.0', '0.1', '0.2', '0.3', '0.4', '0.5', '0.6', '0.7', '0.8', '0.9', '1.0'];

            el.innerHTML = data.score_distribution.map(b => {
                const h = Math.max(4, (b.count / max) * 110);
                const bucket = b.bucket - 1;
                const color = bucket >= 7 ? '#f85149' : bucket >= 5 ? '#d29922' : '#388bfd';
                return `<div class="bar" style="height:${h}px;background:${color}" title="${b.count} leads">
                    <span class="bar-label">${labels[bucket] || ''}</span>
                </div>`;
            }).join('');
        }

        function esc(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        // Init
        loadOverview();
        loadLeads('hot');
        loadPipeline();
        loadCampaigns();
        loadScoreDistribution();

        // Auto-refresh every 30s
        setInterval(() => {
            loadOverview();
            loadLeads(document.querySelector('.tab.active')?.textContent?.toLowerCase());
        }, 30000);
    </script>
</body>
</html>
